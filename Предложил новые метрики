ЗАДАНИЕ №4:Дополнительные метрики

1) Какой % пользователей от их общего числа покупали кодкоины за рубли

with TMP_1 as ( --выбираем пользователей, покупавших кодкоины
	select
		count(distinct user_id) as cnt_user_coins
    from "transaction" t     
    where type_id = 2 and date(created_at) > '2021-10-31' --фильтр по дате запуска платформы с ноября 2021 года
),
TMP_2 as ( --подсчитываем общее кол-во пользователей на платформе
	select count(distinct id) as cnt_all_users
    	from users u
        where date(date_joined) > '2021-10-31'
)	
select 
	round(cnt_user_coins / cnt_all_users::numeric * 100, 2) as persent_of_users_coins
from TMP_1, TMP_2

/*Вывод: на основе полученного значения можно подтвердить тезис о необходимости смены монетизации, 
т.к. от общего количества пользователей только 0,81% покупали кодкоины за рубли.*/  

/*2). Количество пользователей, которые решили задачу с разного числа попыток. 
Данная метрика определяет оптимальное количество попыток в бесплатном доступе*/

with TMP_1 as ( --вычисляем общее кол-во попыток
	select 
		user_id,
		problem_id, 
		sum(is_false) as sum_of_attempt
	from codesubmit c 
	group by user_id, problem_id 
),
TMP_2 as ( --разбиваем попытки по значениям
	select 
		case 
			when sum_of_attempt >= 5 then '5 and more' 
            when sum_of_attempt >= 3 then '3 and more' 
            when sum_of_attempt >= 1 then '1 and more'
            else 'on the first try' 
        end as attempt_group
    from TMP_1 
)
select attempt_group, count(attempt_group) as cnt_users 
from TMP_2
group by attempt_group
order by count(attempt_group) desc 

/*Вывод: 

- 3654 пользователя решали задачи с первой попытки
- 2902 пользователям потребовалось 1-2 дополнительные попытки. 
- 810 потратили от 3 до 5 попыток. 
- 830 человек потратило больше 5 попыток. 

Таким образом, оптимально в бесплатном функционале оставить 2 попытки для решения.*/   


--3). Среднее количество дней на платформе для пользователей, купивших кодкоины за рубли

with TMP_1 as ( --выбираем пользователей, покупавших кодкоины
	select distinct us.id, us.date_joined 
    from "transaction" t 
    inner join users us 
    on us.id = t.user_id 
    where t.type_id = 2
),
TMP_2 as ( --вычисляем max входной интервал после регистрации пользователя на платформе
	select 
    	to_char(us.date_joined,'YYYY-MM') as dt,
        us.id,
        max(case when date(ue.entry_at) - date(us.date_joined) < 0 or date(ue.entry_at) is Null
                 then 0
                 else date(ue.entry_at) - date(us.date_joined)
			end) as nDays --выборка по значениям, т.к в таблице userentry есть user_id у которых вход фиксировался до регистрации или у которых не было входа в день регистрации                       
	from TMP_1 us 
	left join userentry ue
    on us.id = ue.user_id           
	where date(us.date_joined) > '2021-10-31' --фильтр по дате запуска платформы с ноября 2021 года
    group by dt, us.id
)
select round(avg(ndays),2) as avg_days_coin
from TMP_2

/*
Вывод: в среднем такие пользователи находятся на платформе 61 день. Следовательно, пакета код-коинов хватает на 2 месяца. 
Также можно предположить, что люди, которые заплатили на кодкоины, дольше остаются на платформе.
*/


--Итоговые выводы по смене модели монетизации:

/*
Я считаю, что на основании данных, полученных по результатам исследования, будет оптимальна следующая модель подписки: 

 - "Базовый" тариф на 1 месяц (для подготовки к интервью)
 - "Оптимальный" тариф на 2-3 месяца (для развития навыков)
 - "Премиум" тариф на 6 месяцев (без скидки)/1 год (со скидкой) с полным доступом ко всему функционалу платформы

Исходя из того, что 31% пользователей заинтересованы в обучении на протяжении 7-14 дней, 
а 21% пользователей заинтересованы в обучении на протяжении 30 дней. 
Можно было бы сделать подписку на 14 дней, но я думаю для пользователей это неудобно, 
т.к. сейчас все привыкли к месячной подписке.

В бесплатном функционале стоит оставить: 

- 2 попытки на решение задач (в среднем затрачивается примерно 3 попытки на задачу),
- 1 попытку на решение теста (в среднем затрачивается чуть больше 1 попытки). 

Возможность проходить тесты следует поместить в платную подписку, т.к. количество их открытий за кодкоины почти в 2 раза меньше, 
чем за открытие задач (1589 задач/844 тестов). Однако при этом пользователей, которые открывает тесты(588), почти на 40% больше, 
чем тех кто открывает задачи(450).

Топовые задачи с собеседований от компаний должны быть в "Премиум" подписке, что так же повысит интерес к ней.

В конце первой недели после регистрации на платформу заходят в среднем на 14% пользователей меньше. 
Можно предложить бесплатный доступ по тарифу "Премиум" в течение 3-х дней, 
для последующих возвратов и удержания на платформе в будущем. 

Также проанализируем активность пользователей, зарегестрировавшихся в марте-апреле 2022 года. 
На 60-й и 90-й день (т.e в июне-июле) пользователи не заходят на платформу. 
Возможно, стоит перед летними каникулами запустить рекламную кампанию с пакетами заданий со скидками - "Летний интенсив".
*/
